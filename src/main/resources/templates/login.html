<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JWT Authentication Test - MyHealth</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      padding: 25px;
      margin-bottom: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }

    input[type="text"], input[type="password"], textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s ease;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    .btn-success {
      background: #28a745;
    }

    .response-area {
      margin-top: 20px;
    }

    .response-box {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow-y: auto;
    }

    .token-info {
      background: #e7f3ff;
      border: 1px solid #b3d7ff;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }

    .token-info h4 {
      color: #0066cc;
      margin-bottom: 10px;
    }

    .token-display {
      background: #f1f3f4;
      border-radius: 5px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      word-break: break-all;
      margin: 5px 0;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-success { background: #28a745; }
    .status-error { background: #dc3545; }
    .status-warning { background: #ffc107; }

    .api-section {
      border-top: 2px solid #e9ecef;
      padding-top: 20px;
      margin-top: 20px;
    }

    .quick-fill {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .quick-fill button {
      padding: 6px 12px;
      font-size: 0.85rem;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }

    .fill-user { background: #28a745; color: white; }
    .fill-admin { background: #dc3545; color: white; }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>🔐 JWT Authentication Tester</h1>
    <p>Test tất cả các chức năng JWT Authentication của MyHealth API</p>
  </div>

  <div class="grid">
    <!-- Login Section -->
    <div class="card">
      <h2>🚪 Đăng nhập</h2>
      <form id="loginForm">
        <div class="form-group">
          <label for="username">Tên đăng nhập:</label>
          <input type="text" id="username" name="username" required>
        </div>

        <div class="form-group">
          <label for="password">Mật khẩu:</label>
          <input type="password" id="password" name="password" required>
        </div>

        <button type="submit" class="btn">Đăng nhập</button>

        <div class="quick-fill">
          <button type="button" class="fill-user" onclick="fillUser()">Fill User</button>
          <button type="button" class="fill-admin" onclick="fillAdmin()">Fill Admin</button>
        </div>
      </form>

      <div id="loginResponse" class="response-area" style="display: none;">
        <h4>Kết quả đăng nhập:</h4>
        <div id="loginResponseBox" class="response-box"></div>
      </div>
    </div>

    <!-- Token Management -->
    <div class="card">
      <h2>🎫 Quản lý Token</h2>

      <div class="form-group">
        <label for="refreshTokenInput">Refresh Token:</label>
        <textarea id="refreshTokenInput" rows="3" placeholder="Paste refresh token here..."></textarea>
      </div>

      <button class="btn btn-warning" onclick="refreshToken()">🔄 Refresh Token</button>
      <button class="btn btn-secondary" onclick="validateToken()">✅ Validate Token</button>
      <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
      <button class="btn btn-danger" onclick="logoutAll()">🚪 Logout All</button>

      <div id="tokenResponse" class="response-area" style="display: none;">
        <h4>Kết quả Token:</h4>
        <div id="tokenResponseBox" class="response-box"></div>
      </div>
    </div>
  </div>

  <!-- Current Token Info -->
  <div class="card">
    <h2>📋 Thông tin Token hiện tại</h2>
    <div id="currentTokenInfo">
      <p style="color: #666; font-style: italic;">Chưa có token nào được lưu</p>
    </div>
  </div>

  <!-- API Testing Section -->
  <div class="card">
    <h2>🧪 Test API Endpoints</h2>

    <div class="api-section">
      <h3>Authentication Endpoints:</h3>
      <button class="btn" onclick="testLogin()">POST /auth/login</button>
      <button class="btn btn-warning" onclick="testRefresh()">POST /auth/refresh</button>
      <button class="btn btn-secondary" onclick="testValidate()">GET /auth/validate</button>
      <button class="btn btn-danger" onclick="testLogout()">POST /auth/logout</button>
      <button class="btn btn-danger" onclick="testLogoutAll()">POST /auth/logout-all</button>
    </div>

    <div class="api-section">
      <h3>Custom API Tests:</h3>
      <div class="form-group">
        <label for="customEndpoint">Custom Endpoint:</label>
        <input type="text" id="customEndpoint" placeholder="/api/your-endpoint" value="/api/user/profile">
      </div>
      <button class="btn btn-success" onclick="testCustomEndpoint('GET')">GET Request</button>
      <button class="btn btn-success" onclick="testCustomEndpoint('POST')">POST Request</button>
      <button class="btn btn-success" onclick="testCustomEndpoint('PUT')">PUT Request</button>
      <button class="btn btn-success" onclick="testCustomEndpoint('DELETE')">DELETE Request</button>
    </div>

    <div id="apiResponse" class="response-area" style="display: none;">
      <h4>API Response:</h4>
      <div id="apiResponseBox" class="response-box"></div>
    </div>
  </div>
</div>

<script>
  let currentTokens = {
    accessToken: '',
    refreshToken: '',
    tokenType: 'Bearer',
    expiresIn: 0
  };

  // API Base URL - thay đổi theo môi trường của bạn
  const API_BASE_URL = '/my-health/auth';

  // Login functionality
  document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    await performLogin();
  });

  async function performLogin() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    try {
      const response = await fetch(`${API_BASE_URL}/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ username, password })
      });

      const data = await response.json();

      displayResponse('loginResponse', 'loginResponseBox', {
        status: response.status,
        statusText: response.statusText,
        data: data
      }, response.ok);

      if (response.ok) {
        // Lưu token information
        currentTokens.accessToken = data.accessToken || data.token;  // Support both field names
        currentTokens.refreshToken = data.refreshToken;
        currentTokens.tokenType = data.tokenType || 'Bearer';
        currentTokens.expiresIn = data.expiresIn;

        // Auto fill refresh token input
        document.getElementById('refreshTokenInput').value = currentTokens.refreshToken;

        updateTokenDisplay();
      }
    } catch (error) {
      displayResponse('loginResponse', 'loginResponseBox', {
        error: 'Network Error: ' + error.message
      }, false);
    }
  }

  async function refreshToken() {
    const refreshTokenValue = document.getElementById('refreshTokenInput').value || currentTokens.refreshToken;

    if (!refreshTokenValue) {
      alert('Vui lòng nhập refresh token');
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/refresh`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ refreshToken: refreshTokenValue })
      });

      const data = await response.json();

      displayResponse('tokenResponse', 'tokenResponseBox', {
        status: response.status,
        statusText: response.statusText,
        data: data
      }, response.ok);

      if (response.ok) {
        currentTokens.accessToken = data.accessToken || data.token;
        currentTokens.expiresIn = data.expiresIn;
        updateTokenDisplay();
      }
    } catch (error) {
      displayResponse('tokenResponse', 'tokenResponseBox', {
        error: 'Network Error: ' + error.message
      }, false);
    }
  }

  async function validateToken() {
    if (!currentTokens.accessToken) {
      alert('Vui lòng đăng nhập trước');
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/validate`, {
        method: 'GET',
        headers: {
          'Authorization': `${currentTokens.tokenType} ${currentTokens.accessToken}`
        }
      });

      const data = await response.json();

      displayResponse('tokenResponse', 'tokenResponseBox', {
        status: response.status,
        statusText: response.statusText,
        data: data
      }, response.ok);
    } catch (error) {
      displayResponse('tokenResponse', 'tokenResponseBox', {
        error: 'Network Error: ' + error.message
      }, false);
    }
  }

  async function logout() {
    if (!currentTokens.accessToken) {
      alert('Vui lòng đăng nhập trước');
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/logout`, {
        method: 'POST',
        headers: {
          'Authorization': `${currentTokens.tokenType} ${currentTokens.accessToken}`
        }
      });

      const data = await response.text();

      displayResponse('tokenResponse', 'tokenResponseBox', {
        status: response.status,
        statusText: response.statusText,
        data: data
      }, response.ok);

      if (response.ok) {
        clearTokens();
      }
    } catch (error) {
      displayResponse('tokenResponse', 'tokenResponseBox', {
        error: 'Network Error: ' + error.message
      }, false);
    }
  }

  async function logoutAll() {
    if (!currentTokens.accessToken) {
      alert('Vui lòng đăng nhập trước');
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/logout-all`, {
        method: 'POST',
        headers: {
          'Authorization': `${currentTokens.tokenType} ${currentTokens.accessToken}`
        }
      });

      const data = await response.text();

      displayResponse('tokenResponse', 'tokenResponseBox', {
        status: response.status,
        statusText: response.statusText,
        data: data
      }, response.ok);

      if (response.ok) {
        clearTokens();
      }
    } catch (error) {
      displayResponse('tokenResponse', 'tokenResponseBox', {
        error: 'Network Error: ' + error.message
      }, false);
    }
  }

  // Test specific endpoints
  async function testLogin() {
    await performLogin();
  }

  async function testRefresh() {
    await refreshToken();
  }

  async function testValidate() {
    await validateToken();
  }

  async function testLogout() {
    await logout();
  }

  async function testLogoutAll() {
    await logoutAll();
  }

  async function testCustomEndpoint(method = 'GET') {
    const endpoint = document.getElementById('customEndpoint').value;

    if (!endpoint) {
      alert('Vui lòng nhập endpoint');
      return;
    }

    const headers = {};
    if (currentTokens.accessToken) {
      headers['Authorization'] = `${currentTokens.tokenType} ${currentTokens.accessToken}`;
    }

    if (method === 'POST' || method === 'PUT') {
      headers['Content-Type'] = 'application/json';
    }

    try {
      const config = {
        method: method,
        headers: headers
      };

      if (method === 'POST' || method === 'PUT') {
        config.body = JSON.stringify({ test: 'data' });
      }

      const response = await fetch(endpoint, config);

      let data;
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        data = await response.json();
      } else {
        data = await response.text();
      }

      displayResponse('apiResponse', 'apiResponseBox', {
        method: method,
        endpoint: endpoint,
        status: response.status,
        statusText: response.statusText,
        headers: Object.fromEntries(response.headers.entries()),
        data: data
      }, response.ok);
    } catch (error) {
      displayResponse('apiResponse', 'apiResponseBox', {
        method: method,
        endpoint: endpoint,
        error: 'Network Error: ' + error.message
      }, false);
    }
  }

  // Helper functions
  function displayResponse(containerId, boxId, responseData, isSuccess) {
    document.getElementById(containerId).style.display = 'block';
    const box = document.getElementById(boxId);

    box.innerHTML = JSON.stringify(responseData, null, 2);
    box.style.color = isSuccess ? '#28a745' : '#dc3545';
    box.style.borderColor = isSuccess ? '#28a745' : '#dc3545';
  }

  function updateTokenDisplay() {
    const tokenInfo = document.getElementById('currentTokenInfo');

    if (currentTokens.accessToken) {
      tokenInfo.innerHTML = `
                    <div class="token-info">
                        <h4><span class="status-indicator status-success"></span>Token đang hoạt động</h4>
                        <p><strong>Token Type:</strong> ${currentTokens.tokenType}</p>
                        <p><strong>Expires In:</strong> ${currentTokens.expiresIn} seconds</p>
                        <p><strong>Access Token:</strong></p>
                        <div class="token-display">${currentTokens.accessToken}</div>
                        <p><strong>Refresh Token:</strong></p>
                        <div class="token-display">${currentTokens.refreshToken}</div>
                    </div>
                `;
    } else {
      tokenInfo.innerHTML = '<p style="color: #666; font-style: italic;">Chưa có token nào được lưu</p>';
    }
  }

  function clearTokens() {
    currentTokens = {
      accessToken: '',
      refreshToken: '',
      tokenType: 'Bearer',
      expiresIn: 0
    };
    document.getElementById('refreshTokenInput').value = '';
    updateTokenDisplay();
  }

  function fillUser() {
    document.getElementById('username').value = 'user';
    document.getElementById('password').value = '123456';
  }

  function fillAdmin() {
    document.getElementById('username').value = 'admin';
    document.getElementById('password').value = '123456';
  }

  // Initialize display
  updateTokenDisplay();
</script>
</body>
</html>